#* @vtlvariable name="jsessionid" type="java.lang.String" *#
#* @vtlvariable name="session_id" type="java.lang.String" *#
#* @vtlvariable name="scan_type" type="java.lang.String" *#
#* @vtlvariable name="visit_id" type="java.lang.String" *#
#* @vtlvariable name="scan_date" type="java.lang.String" *#
#* @vtlvariable name="subject_id" type="java.lang.String" *#
#* @vtlvariable name="project" type="java.lang.String" *#
#* @vtlvariable name="content" type="org.apache.turbine.services.pull.tools.ContentTool" *#
#* @vtlvariable name="arc" type="org.nrg.xdat.om.ArcArchivespecification" *#
<script type="text/javascript" src="$content.getURI("scripts/java/deployJava.js")"></script>
<div id='appletDiv'>
</div>
<script type="text/javascript">
// The upload applet requires at least Java 1.5 (because of the wizard library).
// We use Java's deployJava.js (http://java.sun.com/javase/6/docs/technotes/guides/jweb/deployment_advice.html)
// to ensure that a supported version of the JRE exists on the client.
// Use an anonymous function to prevent global scope
(function() {
    var SUPPORTED_JRE_VERSIONS = ["1.5", "1.6", "1.7"];
    
    function hasSupport(versions) {
        for (var i=0; i < versions.length; i++) {
            if (deployJava.versionCheck(versions[i])) {
                return true;
            }
        }
        return false;
    }

    if (!hasSupport(SUPPORTED_JRE_VERSIONS)) {
        alert("Applet will not work without supported JRE version.  Requires one of " + SUPPORTED_JRE_VERSIONS.join(", "));
    }
})();

function loadApplet() {
    var appletTag = '<APPLET CODE="org.nrg.upload.ui.UploadAssistantApplet"\n';
    appletTag += '    CODEBASE="$content.getURI("applet/")"\n';
    appletTag += '    ARCHIVE="UploadAssistant-1.5.4-SNAPSHOT.jar,wizard-1.1.0-SNAPSHOT.jar,DicomEdit-1.5.2.jar,DicomUtils-1.2.0.jar,antlr-2.7.6.jar,antlr-runtime-3.2.jar,com.springsource.org.apache.commons.logging-1.1.1.jar,com.springsource.org.apache.log4j-1.2.16.jar,common-1.2.0.jar,commons-codec-1.4.jar,commons-collections-3.1.jar,commons-lang-2.6.jar,dcm4che-core-2.0.25.jar,dicom-xnat-sop-1.5.4-SNAPSHOT.jar,dicom-xnat-util-1.5.4-SNAPSHOT.jar,dom4j-1.6.1.jar,ecat-edit-0.1.2.jar,ecat-io-0.1.0.jar,fest-assert-1.2.jar,fest-reflect-1.2.jar,fest-swing-1.2.1.jar,fest-util-1.1.3.jar,framework-1.0.0-SNAPSHOT.jar,guava-11.0.jar,jackson-core-asl-1.8.5.jar,jackson-mapper-asl-1.8.5.jar,jcalendar-1.4.jar,jcip-annotations-1.0.jar,json-20080701.jar,jsr305-1.3.9.jar,looks-2.4.1.jar,nrgutil-1.0.0.jar,org.restlet-1.1.10.jar,org.springframework.beans-3.0.5.RELEASE.jar,org.springframework.core-3.0.5.RELEASE.jar,org.springframework.web-3.0.5.RELEASE.jar,slf4j-api-1.6.4.jar,slf4j-log4j12-1.6.4.jar,stringtemplate-3.2.jar"\n';
    appletTag += '    width="800"\n';
    appletTag += '    height="500"\n';
    appletTag += '    MAYSCRIPT>\n\n';
    appletTag += '    <PARAM NAME="xnat-url" VALUE="$!arc.getSiteUrl()"/>\n';
    appletTag += '    <PARAM NAME="xnat-admin-email" VALUE="$!arc.getSiteAdminEmail()"/>\n';
    appletTag += '    <PARAM NAME="xnat-description" VALUE="$!arc.getSiteId()"/>\n';
    appletTag += '    <PARAM NAME="n-upload-threads" VALUE="4"/>\n';
    appletTag += '    <PARAM NAME="fixed-size-streaming" VALUE="true"/>\n';
#if( $project )
    appletTag += '    <PARAM NAME="xnat-project" value="$project"/>\n';
    #if( $subject_id )
    appletTag += '    <PARAM NAME="xnat-subject" VALUE="$subject_id"/>\n';
    #end
    #if( $session_id )
    appletTag += '    <PARAM NAME="xnat-session-label" VALUE="$session_id"/>\n';
    #end
    #if( $scan_date )
    appletTag += '    <PARAM NAME="xnat-scan-date" value="$scan_date"/>\n';
    #end
    #if( $visit_id )
    appletTag += '    <PARAM NAME="xnat-visit-id" value="$visit_id"/>\n';
    #end
    #if( $scan_type )
    appletTag += '    <PARAM NAME="xnat-scan-type" value="$scan_type"/>\n';
    #end
#end
    appletTag += '\n';
    appletTag += '    The XNAT upload applet requires Java (1.5 or greater) to be installed on your computer.\n';
    appletTag += '    You can get Java <a href="http://java.com/en/download/index.jsp">here</a>.\n';
    appletTag += '    After installing Java, you will most likely need to restart your browser,\n';
    appletTag += '    and possibly your computer, before the XNAT upload applet will work.\n';
    appletTag += '</APPLET>\n';

    document.getElementById('appletDiv').innerHTML = appletTag;
}

if (YAHOO.util.Cookie.get("appletLoadNotification") == null) {
    var dialog = new YAHOO.widget.SimpleDialog("dialog", {
        width:"20em",
        close:false,
        fixedcenter:true,
        constraintoviewport:true,
        modal:true,
        icon:YAHOO.widget.SimpleDialog.ICON_WARN,
        visible:true,
        draggable:false,
        buttons: [{ text:'OK', isDefault:true, handler: function() {
            this.hide();
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            YAHOO.util.Cookie.set("appletLoadNotification", true, { expires: tomorrow });
            loadApplet();
        } }]
    });

    dialog.render(document.getElementById('layout_content'));
    dialog.setHeader('Applet now loading...');
    dialog.setBody('This page will load the XNAT image upload applet. This may take some time. Please be patient and allow the applet to fully load. Click <b>OK</b> to begin.');
    dialog.bringToTop();
    dialog.show();
} else {
    loadApplet();
}
</script>
