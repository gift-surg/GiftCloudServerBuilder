##Copyright 2005 Harvard University / Howard Hughes Medical Institute (HHMI) All Rights Reserved
$page.addAttribute("onLoad", "document.form1.month.focus();")
	
$page.setTitle("CNDA -- Central Neuroimaging Data Archive")
$page.setLinkColor($ui.alink)
$page.setVlinkColor($ui.vlink)
#set($months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"])
#set($days = [ 1..31 ])
#if ($data.message)
<BR><BR><DIV class="error">$data.message</DIV><br>
#end
#if ($turbineUtils.GetPassedParameter("popup",$data))
	#set ($popup = $turbineUtils.GetPassedParameter("popup",$data) )
#else
	#set ($popup = "false")
#end

#if($vr)
<DIV class="error">Invalid parameters:<BR>$vr.toHTML()</DIV>
<HR>
#end
<form method="post" action="$link.setAction("EditImageSessionAction")" name="form1" id="form1">
#set($scanTypes = [])
	#set($scanQualities = ["usable","unusable","questionable"])
<br>
		   <DIV class="edit_title">#if($om.getId()) Modify #else Add New #end $om.getSchemaElement().getSingularDescription()</DIV>
<INPUT type="hidden" name="xnat:ctSessionData.modality" value="CT"/>
#parse("/screens/xnat_edit_subjectAssessorData.vm")

<INPUT TYPE="hidden" NAME="popup" VALUE="$popup">
												<input type="hidden" name="project" value="$!{project}" >
<table border="0" cellpadding=5>
	<tr>
     	<th align="left">Date</th>
  		<td align="left">
    		<font face="$ui.sansSerifFonts">
    			#set ($expt_date = $!item.getProperty("xnat:ctSessionData.date"))
				<select id="xnat:ctSessionData.date.month" name="xnat:ctSessionData.date.month">
					<option value="bad">(SELECT)</option>
					#foreach ($month in $months)
								#set ($monthCount = $velocityCount - 1)
	            		<option value="$monthCount" #if ( $monthCount == $!expt_date.getMonth()) SELECTED="true" #end>
							$month
						</option>
					#end
				</select>
	
				<select id="xnat:ctSessionData.date.date" name="xnat:ctSessionData.date.date">
					<option value="bad">(SELECT)</option>
					#foreach ($day in $days)
	            		<option value="$day" #if ( $day == $!expt_date.getDate() ) SELECTED="true" #end>$day</option>
					#end
				</select>
    		</font>
		
#set($years = [ $!turbineUtils.getYear()..1990])
			#set ($currentYear = $date.Year + 1900)
			<select id="xnat:ctSessionData.date.year" name="xnat:ctSessionData.date.year" >
				<option value="bad">(SELECT)</option>
				#foreach ($year in $years)
            		<option value="$year" #if ( $year == $!expt_date.getYear() + 1900 ) SELECTED="true" #end>$year</option>
				#end
			</select>
	</td></tr>
	<tr>
		<th align="left">Operator</th>
		  <td align="left">
		  #if ($vr)
	    #if($vr.getField("xnat:ctSessionData.operator"))
		      <font color="red">&#8658</font>
	    #end
  #end
	  #if ($item.getProperty("xnat:ctSessionData.operator"))
	    #if ($item.getProperty("xnat:ctSessionData.operator")=="null")
		      <input type="text" name="xnat:ctSessionData.operator" value=""/>
		    #else
		      <input type="text" name="xnat:ctSessionData.operator" value="$item.getProperty("xnat:ctSessionData.operator")"/>
		    #end
	  #else
	    <input type="text" name="xnat:ctSessionData.operator" value=""/>
	  #end
		  </td>
	</tr>	
	<tr>
		<th align="left">Scanner</th>
		#set($scanners = $item.getPossibleValues("xnat:ctSessionData.scanner"))
		#if($scanners.size()==0)
		<td align="left">#xdatTextBox("xnat:ctSessionData.scanner" $item "" $vr)</td>
		#else
		<td align="left">#xdatSelectBoxWSingleValue("xnat:ctSessionData.scanner" $item $scanners $vr)</td>
		#end
	</tr>
</table>
<BR>

		#parse("/screens/EditProjectSpecificFields.vm")
<BR>
<HR>
<INPUT type="hidden" name="numEmpty" value="$!numEmpty">
		   <DIV class="edit_header1">Scans</DIV><BR>
<TABLE>
#set($scanCount=$om.getScans_scan().size())
	<TR>
	#if($scanCount>0)
	<TH>Remove</TH>
	 #set($scanTotal=$scanCount+5)
	#else
	 #set($scanTotal=15)
	#end
	
	<TH align=center>Scan Number</TH><TH align=center>Type</TH><TH align=center>Quality</TH><TH align=center>Note</TH></TR>
	#foreach($c in [0..$scanTotal] )
	  #set($scan = $om.getSortedScans().get($c))
		<TR>
	#if($scanCount>0)
			<TD align="left">
			#if($!item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].xnat_imagescandata_id"))
				<INPUT TYPE="checkbox" NAME="REMOVE__${c}=xnat:ctScanData.xnat_imagescandata_id" VALUE="$!item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].xnat_imagescandata_id")"/>
#else
				&nbsp;
			#end
			</TD>
	#end
					<INPUT TYPE="hidden" NAME="xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].xnat_imagescandata_id" VALUE="$!item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].xnat_imagescandata_id")"/>
						<td width="135" align="center">
			#if ($vr)
				#if($vr.getField("xnat:ctSessionData.scans.scan[${c}].ID"))
					<font color="red">&#8658</font><BR>
				#end
			#end
			<p>
			#if ($item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].ID"))
				#xdatPKDisplay("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].ID" $item)
			#else
				<INPUT type="text" id="xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].ID" name="xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].ID" value="$!item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].ID")"/>
			#end
			</p>
		    </td>
		    <td>	<!-- align="left" -->
			#if($scanTypes.size()==0)
		    <input type="text" id="xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type" name="xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
		    			 value="$!scan.getProperty("type")"/>
			#else
				#set($matched=false)
				<table>	<!--  cellpadding="0" cellspacing="0" align="left" -->
					<tr>
						<td>	<!-- align="left" -->
							<SELECT id="SEL_xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
										  name="SEL_xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
										  onchange="setSelectValue(this);">
								<OPTION VALUE="">(SELECT)</OPTION>
							#foreach ($pValue in $scanTypes)
								#if($pValue.equals($scan.getProperty("type")))
								<OPTION VALUE="$pValue" SELECTED>$pValue</OPTION>
									#set($matched=true)
								#else
								<OPTION VALUE="$pValue">$pValue</OPTION>
								#end
							#end
							</SELECT>
						#if($matched==false)
							<BR>($scan.getProperty("type"))
						#end
						</td>
						<td>	<!-- align="left" -->
							<DIV ID="IND_xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type">
								<a ID="A_xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
								   onclick="showText(this);">
									<img src="$content.getURI("images/arrow3.gif")" border=0>
								</a>
							</DIV>
						</td>
						<td>	<!-- align="left" -->
							<DIV ID="TEXT_xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
							     style="display:none">
								Enter: <input id="xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
														  type="text" name="xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type"
															value="$!scan.getProperty("type")"/>
							</DIV>
						</td>
					</tr>
				</table>
		  #end
		  #if($scan.getProperty("series_description"))($!scan.getProperty("series_description"))#end
			</td>
<td width="127" align="center">
				#set($currentStatusQuality = $item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].quality"))
			<SELECT id="xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/quality" name="xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/quality">
				<OPTION VALUE="">(SELECT)</OPTION>
				#foreach ($pValue in $scanQualities)
				<OPTION VALUE="$pValue" #if($pValue.equals($currentStatusQuality)) SELECTED #end>$pValue</OPTION>
				#end
				#set($currentStatusQuality = "")
			</SELECT>
	<script type="text/javascript" LANGUAGE="JavaScript">
	function setSelectValue(SELECTbox){
	  if(SELECTbox.selectedIndex!=0)
	  {
	    var name = SELECTbox.name;
	    name = name.substring(4);
	    var NEWvalue=SELECTbox.options[SELECTbox.selectedIndex].value;
	    if (NEWvalue=="")
	    {
	      document.getElementById("TEXT_" + name).style.display="block";
	      document.getElementById("IND_" + name).style.display="none";
	      //SELECTbox.disabled=true;
	    }else{
	      document.getElementById(name).value=NEWvalue;
	    }
	  }
	}
	function showText(ATag){
	    var name = ATag.id;
	    name = name.substring(2);
	      document.getElementById("TEXT_" + name).style.display="block";
	      document.getElementById("IND_" + name).style.display="none";
	}
	</script>
		</td>
		    <td width="215" align="center">
		            <p><input type="text" name="xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].note" value="$!item.getProperty("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].note")" maxlength="255" size="23"></p>
		    </td>
		</TR>
    #end    
</TABLE>
<BR>
<HR>
		   <DIV class="edit_header1">Additional Notes</DIV><BR>
<TABLE>
	<tr>
		#formLabel("Notes")
		<td><textarea name="xnat:ctSessionData.note" rows="4" cols="50" style="text-align:left;">$!notes</textarea></td>
	</tr>
</TABLE><BR><BR><HR>
#auditTable("" "Session Modification")
<table>
#xdatEditProps($item $edit_screen)
<DIV ID="ADDIN"></DIV>
    	<input type="button" ONCLICK="javascript:history.go(-1)" value="Back"/>&nbsp;&nbsp;&nbsp;
    	<input type="button" ONCLICK="validateForm();"  name="eventSubmit_doInsert" value="Submit"/>
    	
	</form>
</table>
<script type="text/javascript">
function validateForm()
{
      
	#foreach($c in [0..$scanTotal] )
   if(document.getElementById("xnat:ctSessionData.scans.scan[${c}][@xsi:type=xnat:ctScanData].ID").value!="")
   {
/*
     if(document.getElementById("xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/quality").selectedIndex==0)
     {
       document.getElementById("xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/quality").focus();
       alert("Please select a usability for each scan.");
       return false;
     }
*/
     if(document.getElementById("xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type").value=="")
     {
       document.getElementById("SEL_xnat:ctSessionData/scans/scan[${c}][@xsi:type=xnat:ctScanData]/type").focus();
       alert("Please select a type for each scan.");
       return false;
     } 
   }	
   	#end

   validateSubjectAssessorForm();
   
   return false;
}
</script>
			